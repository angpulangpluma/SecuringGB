/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package dropbox;

import com.dropbox.core.*;
import com.dropbox.core.v1.DbxEntry;
import com.dropbox.core.v2.*;
import com.dropbox.core.v2.files.FolderMetadata;
import com.dropbox.core.v2.files.ListFolderResult;
import com.dropbox.core.v2.files.Metadata;
import java.util.ArrayList;
import javax.swing.DefaultListModel;

/**
 *
 * @author YING LOPEZ
 */
public class dbInterface extends javax.swing.JFrame {

    /**
     * Creates new form dbInterface
     */
    
    private static final String ACCESS_TOKEN = "I9h5pIu_C2AAAAAAAAAAX-7E5iZmUqhT3n7Jo8MQ7M3c2fyzV6tyMQsdmecbwAoO";
    private DbxRequestConfig config = null;
    private DbxClientV2 client = null;
    private DefaultListModel model = null;
    private String curFolder = null;
    private ArrayList<FolderMetadata> folders = null;
    
    public dbInterface() {
        config = new DbxRequestConfig("DrpBxWithEncryption", "en_US");
        client = new DbxClientV2(config, ACCESS_TOKEN);
        
        model = new DefaultListModel();
        fileList.setModel(model);
        
        curFolder = "";
        folders = new ArrayList<FolderMetadata>();
        initComponents();
        try{
        refreshFiles(curFolder);
        knowFolders();
        } catch (Exception e){
            e.printStackTrace();
           System.exit(1);
        }
    }
    
    private void knowFolders() throws Exception{
        boolean isFolder = false;
        ArrayList<Integer> folderindices = new ArrayList<Integer>();
        int fi = 0;
        int cnt = 0;
        ListFolderResult result = client.files().listFolder("");
            while(true){
                for(Metadata metadata : result.getEntries()){
//                    System.out.println(metadata.getPathLower());
                    if(metadata instanceof FolderMetadata){
                        model.addElement(metadata.getName());
                        folders.add((FolderMetadata)metadata);
                        cnt++;
                        isFolder = true;
                    }
                }
                
                if (!result.getHasMore() && isFolder){
                    
                    result = client.files().listFolder(folders.get(folderindices.get(fi)).getName());
                }

                else if (!result.getHasMore() && !isFolder)
                    break;
            }
    }
    
    //note: when displaying, also include a 'Go Back to Source Folder'
    //   when traversing inside folders
    private void refreshFiles(String folderPath) throws Exception{
        model.clear();
        if (folderPath != ""){
            model.addElement("Go Back Up");
        }
        
        //list files in that folder        
        ListFolderResult result = client.files().listFolder(folderPath);
            while(true){
                for(Metadata metadata : result.getEntries()){
//                    System.out.println(metadata.getPathLower());
                    model.addElement(metadata.getName());
                }

                if (!result.getHasMore())
                    break;
            }
        
        curFolder = folderPath;

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        accntTxtField = new javax.swing.JTextField();
        fileListScrollPane = new javax.swing.JScrollPane();
        fileList = new javax.swing.JList();
        uploadBtn = new javax.swing.JButton();
        exitBtn = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

        jLabel1.setText("Name");

        accntTxtField.setEditable(false);

        fileListScrollPane.setHorizontalScrollBarPolicy(javax.swing.ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);

        fileList.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        fileList.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                fileListMouseClicked(evt);
            }
        });
        fileListScrollPane.setViewportView(fileList);

        uploadBtn.setText("Upload");
        uploadBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                uploadBtnActionPerformed(evt);
            }
        });

        exitBtn.setText("Exit");
        exitBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                exitBtnActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(fileListScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jLabel1)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(accntTxtField))
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(uploadBtn)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 73, Short.MAX_VALUE)
                        .addComponent(exitBtn)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(7, 7, 7)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(accntTxtField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel1))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(fileListScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 237, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 10, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(uploadBtn)
                    .addComponent(exitBtn))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void fileListMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_fileListMouseClicked
        // TODO add your handling code here:
        if (evt.getClickCount()==2){
            //Metadata item = client.files().getMetadata(<insert list item here>);
            //if (item instanceof FolderMetadata)
            //refresh to list items inside that folder
            //else if (item instance of FileMetadata)
            //ask whether user wants to download the file
            //if yes, download
            //else view the file, check extension
            //else .... find out how to traverse folders
        }
    }//GEN-LAST:event_fileListMouseClicked

    private void uploadBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_uploadBtnActionPerformed
        // TODO add your handling code here:
        //insert code from dbSnippet abt uploading files here
        //add option to save in folder
    }//GEN-LAST:event_uploadBtnActionPerformed

    private void exitBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_exitBtnActionPerformed
        // TODO add your handling code here:
        System.exit(0);
    }//GEN-LAST:event_exitBtnActionPerformed
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField accntTxtField;
    private javax.swing.JButton exitBtn;
    private javax.swing.JList fileList;
    private javax.swing.JScrollPane fileListScrollPane;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JButton uploadBtn;
    // End of variables declaration//GEN-END:variables
}
